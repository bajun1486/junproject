package com.example.hansei.recruitmentapi.controller;

import java.util.List;
import java.util.Objects;
import java.util.stream.Collectors;

import org.springframework.http.ResponseEntity;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import com.example.hansei.entity.HanUser;
import com.example.hansei.recruitmentapi.dto.EventDto;
import com.example.hansei.recruitmentapi.repository.EventFavoriteRepository;
import com.example.hansei.recruitmentapi.service.EventFavoriteService;
import com.example.hansei.security.user.CustomUser;

import lombok.RequiredArgsConstructor;

@RestController
@RequestMapping("/api/work-favorites")
@RequiredArgsConstructor
public class EventFavoriteController {

    private final EventFavoriteService eventFavoriteService;
    private final EventFavoriteRepository eventFavoriteRepository;

    // ğŸ“Œ ì¦ê²¨ì°¾ê¸° ì¶”ê°€
    @PostMapping("/{eventNo}")
    public ResponseEntity<String> addFavorite(@AuthenticationPrincipal CustomUser customUser,
                                              @PathVariable String eventNo) {
        if (customUser == null) {
            return ResponseEntity.status(401).body("ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        }

        HanUser user = customUser.getUser();
        eventFavoriteService.addFavorite(user.getUserId(), eventNo);

        return ResponseEntity.ok("ì¦ê²¨ì°¾ê¸°ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    // ğŸ“Œ ì¦ê²¨ì°¾ê¸° ì‚­ì œ
    @DeleteMapping("/{eventNo}")
    public ResponseEntity<String> removeFavorite(@AuthenticationPrincipal CustomUser customUser,
                                                 @PathVariable String eventNo) {
        if (customUser == null) {
            return ResponseEntity.status(401).body("ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        }

        HanUser user = customUser.getUser();
        eventFavoriteService.removeFavorite(user.getUserId(), eventNo);

        return ResponseEntity.ok("ì¦ê²¨ì°¾ê¸°ì—ì„œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    // ğŸ“Œ ì‚¬ìš©ìì˜ ì¦ê²¨ì°¾ê¸° ëª©ë¡ ì¡°íšŒ
    @GetMapping
    public ResponseEntity<List<String>> getUserFavorites(@AuthenticationPrincipal CustomUser customUser) {
        if (customUser == null) {
            return ResponseEntity.status(401).body(null);
        }

        HanUser user = customUser.getUser();
        List<String> favorites = eventFavoriteService.getUserFavorites(user.getUserId());

        return ResponseEntity.ok(favorites);
    }

        public List<EventDto> getUserFavoriteEvents(Long userId) {
            // 1ï¸âƒ£ ì¦ê²¨ì°¾ê¸°í•œ ì´ë²¤íŠ¸ ID ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            List<String> favoriteEventIds = eventFavoriteRepository.findEventIdsByUserId(userId);

            // 2ï¸âƒ£ ì´ë²¤íŠ¸ IDë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì‹¤ì œ ì´ë²¤íŠ¸ ì •ë³´ ì¡°íšŒ
            return favoriteEventIds.stream()
                    .map(eventId -> eventRepository.findById(eventId)
                            .map(EventDto::fromEntity) // â­ Entity -> DTO ë³€í™˜
                            .orElse(null)) // ì´ë²¤íŠ¸ê°€ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ null ë°˜í™˜
                    .filter(Objects::nonNull) // â­ null ê°’ ì œê±°
                    .collect(Collectors.toList());
        }
    }

}
